

# Plano: Sistema Completo de RegulaÃ§Ã£o com Fluxo Expandido

## VisÃ£o Geral do Novo Fluxo

O sistema de regulaÃ§Ã£o serÃ¡ reformulado para refletir a comunicaÃ§Ã£o real entre equipe assistencial e NIR:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    FLUXO DE REGULAÃ‡ÃƒO                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                â”‚
â”‚  EQUIPE ASSISTENCIAL                           NIR                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”€â”€â”€                                             â”‚
â”‚                                                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                       â”‚
â”‚  â”‚ 1. SOLICITA         â”‚                                                                       â”‚
â”‚  â”‚    REGULAÃ‡ÃƒO        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                               â”‚       â”‚
â”‚                                                                                        v       â”‚
â”‚                                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                                                        â”‚ 2. AGUARDANDO       â”‚ â”‚
â”‚                                                                        â”‚    REGULAÃ‡ÃƒO        â”‚ â”‚
â”‚                                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚     â”‚          â”‚
â”‚                                                                               â”‚     v          â”‚
â”‚                                                                               â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                                                               â”‚  â”‚ NEGADO    â”‚ â”‚
â”‚                                                                               â”‚  â”‚ NIR       â”‚ â”‚
â”‚                                                                               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               v                â”‚
â”‚                                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                                                        â”‚ 3. REGULADO         â”‚ â”‚
â”‚                                                                        â”‚ (Listado no sistema)â”‚ â”‚
â”‚                                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚     â”‚          â”‚
â”‚                                                                               â”‚     v          â”‚
â”‚                                                                               â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                                                               â”‚  â”‚ NEGADO    â”‚ â”‚
â”‚                                                                               â”‚  â”‚ HOSPITAL  â”‚ â”‚
â”‚                                                                               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               v                â”‚
â”‚                                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                                                        â”‚ 4. AGUARD. TRANSF.  â”‚ â”‚
â”‚                                                                        â”‚ (Vaga confirmada)   â”‚ â”‚
â”‚                                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚                â”‚
â”‚                                                                               v                â”‚
â”‚                                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                                                        â”‚ 5. TRANSFERIDO      â”‚ â”‚
â”‚                                                                        â”‚ (Finalizado)        â”‚ â”‚
â”‚                                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                                                â”‚
â”‚  MUDANÃ‡A DE ESPECIALIDADE (A qualquer momento pela Eq. Assistencial)                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚
â”‚                                                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Neuro â†’ Cardio  â”‚  Exemplo: Paciente que estava listado para Neurologia                 â”‚ â”‚
â”‚  â”‚  + Justificativa â”‚  agora precisa de Cardiologia. Retorna ao inÃ­cio do fluxo.           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Estados do Sistema

| Status | RÃ³tulo | Quem Altera | DescriÃ§Ã£o |
|--------|--------|-------------|-----------|
| `aguardando_regulacao` | Aguardando RegulaÃ§Ã£o | AutomÃ¡tico | SolicitaÃ§Ã£o criada pela equipe |
| `regulado` | Regulado | NIR | NIR listou no sistema externo |
| `aguardando_transferencia` | Aguard. TransferÃªncia | NIR | Vaga confirmada pelo hospital |
| `transferido` | Transferido | NIR | Paciente foi transferido (finaliza) |
| `negado_nir` | Negado (NIR) | NIR | NIR recusou regular (com justificativa) |
| `negado_hospital` | Negado (Hospital) | NIR | Hospital recusou vaga (com justificativa) |

## AÃ§Ãµes DisponÃ­veis por Status

### NIR pode:

| Status Atual | AÃ§Ãµes PossÃ­veis |
|--------------|-----------------|
| Aguardando RegulaÃ§Ã£o | `Regular` ou `Negar (NIR)` |
| Regulado | `Confirmar Vaga` ou `Negado (Hospital)` |
| Aguard. TransferÃªncia | `Marcar Transferido` |
| Negado NIR | - (estado final, mas equipe pode criar nova solicitaÃ§Ã£o) |
| Negado Hospital | `Re-regular` (volta para Regulado) |

### Equipe Assistencial pode:

| Status Atual | AÃ§Ãµes PossÃ­veis |
|--------------|-----------------|
| Qualquer status ativo | `Alterar Especialidade` (com justificativa obrigatÃ³ria) |
| Qualquer status | `Cancelar SolicitaÃ§Ã£o` |

## MudanÃ§a de Especialidade

Quando a equipe assistencial muda a especialidade:

1. **ObrigatÃ³rio**: Justificativa da mudanÃ§a
2. **Resultado**: Status volta para `aguardando_regulacao`
3. **HistÃ³rico**: Registrado `previous_support_type` e `change_reason`

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Alterar Especialidade                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚ Especialidade Atual: ğŸ§  Neurologia                                          â”‚
â”‚                                                                             â”‚
â”‚ Nova Especialidade:                                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚  â¤ï¸ Cardiologia                                              â–¼       â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚ Justificativa da mudanÃ§a: *                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Paciente evoluiu com arritmia grave necessitando de suporte          â”‚   â”‚
â”‚ â”‚ cardiolÃ³gico. IndicaÃ§Ã£o neurolÃ³gica mantida, mas prioridade           â”‚   â”‚
â”‚ â”‚ agora Ã© cardiologia.                                                  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚ âš ï¸ AtenÃ§Ã£o: Isso reiniciarÃ¡ o processo de regulaÃ§Ã£o.                        â”‚
â”‚                                                                             â”‚
â”‚                                    [ Cancelar ]  [ Confirmar MudanÃ§a ]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## VisualizaÃ§Ã£o para Equipe Assistencial

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¥ RegulaÃ§Ã£o                                                         [+]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ ğŸ§  Neurologia                                     [Regulado] â”‚          â”‚
â”‚  â”‚    Solicitado: 27/01 | Regulado: 27/01                        â”‚          â”‚
â”‚  â”‚    [ âœï¸ Alterar Especialidade ]                     [x]       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ â¤ï¸ Cardiologia                         [Aguard. TransferÃªncia]â”‚          â”‚
â”‚  â”‚    Solicitado: 26/01 | Vaga: 27/01                            â”‚          â”‚
â”‚  â”‚    âš ï¸ Mudado de Neurologia em 26/01                           â”‚          â”‚
â”‚  â”‚       "Paciente evoluiu com complicaÃ§Ã£o cardÃ­aca"             â”‚          â”‚
â”‚  â”‚    [ âœï¸ Alterar Especialidade ]                     [x]       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ ğŸ« TorÃ¡cica                                   [Negado - NIR]  â”‚          â”‚
â”‚  â”‚    "Paciente nÃ£o elegÃ­vel para programa de crÃ´nicos."        â”‚  [x]     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## SeÃ§Ã£o TÃ©cnica

### 1. AlteraÃ§Ãµes no Banco de Dados

Nova migraÃ§Ã£o SQL para expandir a tabela `patient_regulation`:

```sql
-- Adicionar timestamps para cada etapa do fluxo
ALTER TABLE patient_regulation
ADD COLUMN IF NOT EXISTS regulated_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS confirmed_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS transferred_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS denied_at TIMESTAMPTZ;

-- Campos para mudanÃ§a de especialidade
ALTER TABLE patient_regulation
ADD COLUMN IF NOT EXISTS previous_support_type TEXT,
ADD COLUMN IF NOT EXISTS change_reason TEXT,
ADD COLUMN IF NOT EXISTS changed_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS changed_by UUID;

-- Migrar dados existentes
UPDATE patient_regulation 
SET status = 'aguardando_regulacao' 
WHERE status = 'aguardando';

UPDATE patient_regulation 
SET status = 'aguardando_transferencia',
    confirmed_at = updated_at
WHERE status = 'confirmado';

UPDATE patient_regulation 
SET status = 'negado_nir',
    denied_at = updated_at
WHERE status = 'negado';
```

### 2. Atualizar Tipos TypeScript

**`src/types/database.ts`**:

```typescript
export type RegulationStatus = 
  | 'aguardando_regulacao'
  | 'regulado'
  | 'aguardando_transferencia'
  | 'transferido'
  | 'negado_nir'
  | 'negado_hospital';

export interface PatientRegulation {
  id: string;
  patient_id: string;
  support_type: string;
  status: RegulationStatus;
  requested_at: string;
  regulated_at: string | null;
  confirmed_at: string | null;
  transferred_at: string | null;
  denied_at: string | null;
  denial_reason: string | null;
  // MudanÃ§a de especialidade
  previous_support_type: string | null;
  change_reason: string | null;
  changed_at: string | null;
  changed_by: string | null;
  // Outros
  updated_at: string;
  is_active: boolean;
  notes: string | null;
  created_by: string;
  updated_by: string | null;
}
```

### 3. Novo STATUS_CONFIG Expandido

```typescript
const STATUS_CONFIG = {
  aguardando_regulacao: {
    label: 'Aguardando RegulaÃ§Ã£o',
    shortLabel: 'Aguard. Reg.',
    className: 'bg-amber-100 text-amber-800 border-amber-300 ...',
    icon: Clock,
    description: 'Aguardando NIR registrar no sistema'
  },
  regulado: {
    label: 'Regulado',
    shortLabel: 'Regulado',
    className: 'bg-blue-100 text-blue-800 border-blue-300 ...',
    icon: FileCheck,
    description: 'NIR listou na central de regulaÃ§Ã£o'
  },
  aguardando_transferencia: {
    label: 'Aguard. TransferÃªncia',
    shortLabel: 'Aguard. Transf.',
    className: 'bg-green-100 text-green-800 border-green-300 ...',
    icon: Ambulance,
    description: 'Vaga confirmada, aguardando transporte'
  },
  transferido: {
    label: 'Transferido',
    shortLabel: 'Transferido',
    className: 'bg-teal-100 text-teal-800 border-teal-300 ...',
    icon: CheckCircle2,
    description: 'Paciente transferido com sucesso'
  },
  negado_nir: {
    label: 'Negado (NIR)',
    shortLabel: 'Neg. NIR',
    className: 'bg-red-100 text-red-800 border-red-300 ...',
    icon: XCircle,
    description: 'NIR recusou regular esta solicitaÃ§Ã£o'
  },
  negado_hospital: {
    label: 'Negado (Hospital)',
    shortLabel: 'Neg. Hospital',
    className: 'bg-orange-100 text-orange-800 border-orange-300 ...',
    icon: Building2,
    description: 'Hospital destino recusou a vaga'
  }
} as const;
```

### 4. LÃ³gica de TransiÃ§Ãµes

```typescript
// TransiÃ§Ãµes que o NIR pode fazer
const NIR_TRANSITIONS: Record<RegulationStatus, {status: RegulationStatus, label: string, variant?: string}[]> = {
  aguardando_regulacao: [
    { status: 'regulado', label: 'Marcar Regulado' },
    { status: 'negado_nir', label: 'Negar RegulaÃ§Ã£o', variant: 'destructive' }
  ],
  regulado: [
    { status: 'aguardando_transferencia', label: 'Confirmar Vaga' },
    { status: 'negado_hospital', label: 'Negado pelo Hospital', variant: 'destructive' }
  ],
  aguardando_transferencia: [
    { status: 'transferido', label: 'Marcar Transferido' }
  ],
  transferido: [],
  negado_nir: [],
  negado_hospital: [
    { status: 'regulado', label: 'Re-regular' }
  ]
};
```

### 5. Novo Componente: ChangeSpecialtyDialog

Novo componente para mudanÃ§a de especialidade pela equipe assistencial:

```tsx
// src/components/patient/ChangeSpecialtyDialog.tsx
interface ChangeSpecialtyDialogProps {
  regulation: PatientRegulation;
  isOpen: boolean;
  onClose: () => void;
  onUpdate: () => void;
}

// Permite selecionar nova especialidade e exige justificativa
// Ao confirmar:
// 1. Salva previous_support_type = support_type atual
// 2. Salva change_reason = justificativa
// 3. Atualiza support_type = nova especialidade
// 4. Reseta status para 'aguardando_regulacao'
// 5. Limpa regulated_at, confirmed_at, denied_at
```

### 6. Arquivos a Modificar

| Arquivo | AlteraÃ§Ã£o |
|---------|-----------|
| **MigraÃ§Ã£o SQL** | Novas colunas para timestamps e mudanÃ§a de especialidade |
| `src/types/database.ts` | Atualizar tipo PatientRegulation com novos campos |
| `src/components/patient/PatientRegulation.tsx` | Novo STATUS_CONFIG, botÃ£o de alterar especialidade, exibiÃ§Ã£o de histÃ³rico de mudanÃ§a |
| `src/components/patient/ChangeSpecialtyDialog.tsx` | **NOVO** - Dialog para mudanÃ§a de especialidade |
| `src/components/nir/NIRRegulationDialog.tsx` | Novo STATUS_CONFIG, botÃµes de aÃ§Ã£o baseados em transiÃ§Ãµes permitidas |
| `src/components/nir/NIRDashboard.tsx` | Atualizar filtros para novos status |
| `src/components/nir/NIRBedCard.tsx` | Badge com status detalhado |

### 7. Ordem de ImplementaÃ§Ã£o

1. Criar migraÃ§Ã£o SQL com novos campos
2. Atualizar tipos em `database.ts`
3. Criar componente `ChangeSpecialtyDialog.tsx`
4. Atualizar `PatientRegulation.tsx` (view da equipe assistencial)
5. Atualizar `NIRRegulationDialog.tsx` (aÃ§Ãµes do NIR)
6. Atualizar `NIRDashboard.tsx` (filtros e contadores)
7. Atualizar `NIRBedCard.tsx` (badges de status)

